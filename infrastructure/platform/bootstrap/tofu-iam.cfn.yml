---
AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy terraform operational infrastructure
Parameters:
  StateBucketName:
    Type: String
    Description: Name of the S3 bucket for terraform state
  LockTableName:
    Type: String
    Description: Name of the terraform DynamoDB lock table

Resources:
  MyIAMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: TofuRemoteStateRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:List*
                Resource:
                  - !Sub "arn:aws:s3:::${StateBucketName}-${AWS::Region}-${AWS::AccountId}"
                  - !Sub "arn:aws:s3:::${StateBucketName}-${AWS::Region}-${AWS::AccountId}/*"
        - PolicyName: DynamoDBAccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:DeleteItem
                Resource: !Sub "arn:aws:dynamodb:ap-southeast-2:*:table/${LockTableName}-${AWS::Region}-${AWS::AccountId}"
